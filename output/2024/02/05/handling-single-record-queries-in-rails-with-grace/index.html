<!DOCTYPE html>
<html lang="    en
">
<head>
            <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="HandheldFriendly" content="True" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

            <meta name="robots" content="" />

        <link rel="stylesheet" type="text/css" href="https://deekap.com/theme/css/main.css" />


            <link href="https://deekap.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="deekap Atom" />
        <link href="https://deekap.com/feeds/2024-02-05-rails-ensure-only-one-record.atom.xml" type="application/atom+xml" rel="alternate" title="deekap Categories Atom Feed" />


            <link rel="canonical" href="https://deekap.com" />
            <meta name="title" content="deekap">
            <meta name="author" content="Deepak" />
            <meta name="description" content="" />

            <meta property="og:site_name" content="deekap"/>
            <meta property="og:type" content="blog"/>
            <meta property="og:title" content="deekap"/>
            <meta property="og:description" content=""/>
            <meta property="og:locale" content=""/>
            <meta property="og:url" content="https://deekap.com"/>

            <meta property="twitter:card" content="summary">
            <meta property="twitter:url" content="https://deekap.com">
            <meta property="twitter:title" content="deekap">
            <meta property="twitter:description" content="">

        <title>    deekap - Handling Single Record Queries in Rails with Grace
</title>





        <meta name="tags" content="Ruby" />
        <meta name="tags" content="ActiveRecord" />
        <meta name="tags" content="Rails" />
</head>

<body>
  <header>
  <div class="title-bar">
    <div>
      <a href="https://deekap.com" class="title">
        <h2>deekap</h2>
      </a>
    </div>
    
    <button id="theme-toggle" aria-label="Toggle Theme">●</button>
    
  </div>

        <nav>
            <p>
                <a href="/">Home</a>
                <a href="/blog">Blog</a>
                <a href="/pages/about">About</a>
            </p>
        </nav>
</header>
    <main>
    <h1 class="entry-title">
        Handling Single Record Queries in Rails with Grace
    </h1>

    

    <i class="date">
        <address class="authors">
        </address>
        <div class="category">
        </div>
        <div>
            <time class="published" datetime="2024-02-05T00:00:00+11:00">
                Mon 05 February 2024
            </time>
        </div>
        <div>
        </div>
    </i>
    <content>
        <p>In Ruby on Rails, when dealing with database queries, there are instances where we anticipate a query to return a single record. This expectation arises in scenarios where the uniqueness of a record is integral to the application's logic. However, databases can sometimes contain duplicates or multiple records that meet the query criteria, leading to potential conflicts or unexpected behavior in our application. To ensure robust and error-free application behavior, it's essential to handle these cases effectively.</p>
<p>Consider a scenario where we query the Book model for all its records:</p>
<div class="highlight"><pre><span></span><code><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">01</span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="no">Book</span><span class="o">.</span><span class="n">all</span>
<span class="w">  </span><span class="no">Book</span><span class="w"> </span><span class="no">Load</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span><span class="w">  </span><span class="no">SELECT</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="o">.</span><span class="n n-Operator">*</span><span class="w"> </span><span class="no">FROM</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="w"> </span><span class="sr">/* loading for pp */</span><span class="w"> </span><span class="no">LIMIT</span><span class="w"> </span><span class="p">?</span><span class="w">  </span><span class="o">[[</span><span class="s2">&quot;LIMIT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="o">]]</span>
<span class="o">=&gt;</span>
<span class="o">[</span><span class="c1">#&lt;Book:0x000000010e29cbd8</span>
<span class="w">  </span><span class="nb">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Catcher in The Rye&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="ss">price</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">1599</span><span class="n">e2</span><span class="p">,</span>
<span class="w">  </span><span class="ss">created_at</span><span class="p">:</span><span class="w"> </span><span class="no">Wed</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="no">Jan</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">46</span><span class="o">.</span><span class="mi">668892000</span><span class="w"> </span><span class="no">UTC</span><span class="w"> </span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
<span class="w">  </span><span class="ss">updated_at</span><span class="p">:</span><span class="w"> </span><span class="no">Wed</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="no">Jan</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">26</span><span class="o">.</span><span class="mi">612252000</span><span class="w"> </span><span class="no">UTC</span><span class="w"> </span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
<span class="w">  </span><span class="ss">published_date</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w"> </span><span class="c1">#&lt;Book:0x000000010e29ca98</span>
<span class="w">  </span><span class="nb">id</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Dracula&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="ss">price</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">2299</span><span class="n">e2</span><span class="p">,</span>
<span class="w">  </span><span class="ss">created_at</span><span class="p">:</span><span class="w"> </span><span class="no">Wed</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="no">Jan</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">08</span><span class="o">.</span><span class="mi">507102000</span><span class="w"> </span><span class="no">UTC</span><span class="w"> </span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
<span class="w">  </span><span class="ss">updated_at</span><span class="p">:</span><span class="w"> </span><span class="no">Wed</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="no">Jan</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">08</span><span class="o">.</span><span class="mi">507102000</span><span class="w"> </span><span class="no">UTC</span><span class="w"> </span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
<span class="w">  </span><span class="ss">published_date</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w"> </span><span class="c1">#&lt;Book:0x000000010e29c958</span>
<span class="w">  </span><span class="nb">id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">  </span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Catcher in The Rye&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="ss">price</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">2299</span><span class="n">e2</span><span class="p">,</span>
<span class="w">  </span><span class="ss">created_at</span><span class="p">:</span><span class="w"> </span><span class="no">Mon</span><span class="p">,</span><span class="w"> </span><span class="mo">05</span><span class="w"> </span><span class="no">Feb</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="mo">07</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">12</span><span class="o">.</span><span class="mi">511819000</span><span class="w"> </span><span class="no">UTC</span><span class="w"> </span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
<span class="w">  </span><span class="ss">updated_at</span><span class="p">:</span><span class="w"> </span><span class="no">Mon</span><span class="p">,</span><span class="w"> </span><span class="mo">05</span><span class="w"> </span><span class="no">Feb</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="mo">07</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">12</span><span class="o">.</span><span class="mi">511819000</span><span class="w"> </span><span class="no">UTC</span><span class="w"> </span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>
<span class="w">  </span><span class="ss">published_date</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="o">&gt;]</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">01</span><span class="mi">9</span><span class="o">&gt;</span>
</code></pre></div>

<p>In this example, we retrieve multiple Book records. While this direct fetch is straightforward for multiple records, complications arise when our logic expects only a single record in return.</p>
<h3>The Challenge of Ensuring Uniqueness</h3>
<p>Suppose we want to fetch a book by its title, expecting that title to be unique. However, if our database has multiple entries for the same title, this assumption breaks, and our application might behave unpredictably.</p>
<p>To tackle this, we could write a method like get_book:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_book</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="w">    </span><span class="n">books</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="n">title</span><span class="p">)</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotUnique</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">books</span><span class="o">.</span><span class="n">many?</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">books</span><span class="o">.</span><span class="n">first</span>
<span class="k">end</span>
</code></pre></div>

<p>This method fetches all books matching the given title and raises an exception if more than one record is found, effectively enforcing our uniqueness constraint. Here's how it behaves:</p>
<div class="highlight"><pre><span></span><code><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">040</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_book</span><span class="p">(</span><span class="s2">&quot;Catcher in The Rye&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="no">Book</span><span class="w"> </span><span class="no">Count</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span><span class="w">  </span><span class="no">SELECT</span><span class="w"> </span><span class="no">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="no">FROM</span><span class="w"> </span><span class="p">(</span><span class="no">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">AS</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="no">FROM</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="w"> </span><span class="no">WHERE</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="no">LIMIT</span><span class="w"> </span><span class="sc">?)</span><span class="w"> </span><span class="n">subquery_for_count</span><span class="w">  </span><span class="o">[[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Catcher in The Rye&quot;</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="s2">&quot;LIMIT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">]]</span>
<span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">35</span><span class="ss">:in</span><span class="w"> </span><span class="sb">`get_book&#39;: ActiveRecord::RecordNotUnique (ActiveRecord::RecordNotUnique)</span>
<span class="sb">irb(main):041&gt;</span>
</code></pre></div>

<h3>A More Elegant Solution with .sole</h3>
<p>While the above method works, Rails offers a cleaner, more idiomatic way to achieve the same result with the .sole method. This method is designed to return a single record and automatically raises an ActiveRecord::SoleRecordExceeded exception if more than one record matches the query, simplifying our approach:</p>
<p>The get_book method can be shortened to this</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_book</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="w">    </span><span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">sole</span>
<span class="k">end</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">045</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_book</span><span class="p">(</span><span class="s2">&quot;Catcher in The Rye&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="no">Book</span><span class="w"> </span><span class="no">Load</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span><span class="w">  </span><span class="no">SELECT</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="o">.</span><span class="n n-Operator">*</span><span class="w"> </span><span class="no">FROM</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="w"> </span><span class="no">WHERE</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="no">ORDER</span><span class="w"> </span><span class="no">BY</span><span class="w"> </span><span class="s2">&quot;books&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span><span class="w"> </span><span class="no">ASC</span><span class="w"> </span><span class="no">LIMIT</span><span class="w"> </span><span class="p">?</span><span class="w">  </span><span class="o">[[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Catcher in The Rye&quot;</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="s2">&quot;LIMIT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">]]</span>
<span class="sr">/Users/</span><span class="n">deepak</span><span class="o">/.</span><span class="n">rbenv</span><span class="o">/</span><span class="n">versions</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">activerecord</span><span class="o">-</span><span class="mi">7</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">active_record</span><span class="o">/</span><span class="n">relation</span><span class="o">/</span><span class="n">finder_methods</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">141</span><span class="ss">:in</span><span class="w"> </span><span class="sb">`sole&#39;: Wanted only one Book (ActiveRecord::SoleRecordExceeded)</span>
</code></pre></div>

<p>This approach is not only cleaner but also more efficient, as it communicates our intent more clearly and leverages Rails' built-in mechanisms for enforcing record uniqueness.</p>
<h1>11</h1>
    </content>
        <p class="tags">
                <a href="https://deekap.com/tag/ruby.html">#Ruby</a>
                <a href="https://deekap.com/tag/activerecord.html">#ActiveRecord</a>
                <a href="https://deekap.com/tag/rails.html">#Rails</a>
        </p>
    </main>
    <footer>
        <address id="about" class="vcard body">
          <small>
            Powered by <a href="https://getpelican.com/">Pelican</a>
            <br>
            Theme inspired by <a href="https://bearblog.dev">Bear ʕ•ᴥ•ʔ</a>
            </small>
        </address>
    </footer>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
      function setTheme(theme) {
        document.body.classList.toggle("dark-theme", theme === "dark");
        localStorage.setItem("theme", theme);
      }

      let theme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      setTheme(theme);

        document.getElementById("theme-toggle").addEventListener("click", function (event) {
          event.preventDefault();
          theme = theme === "dark" ? "light" : "dark";
          setTheme(theme);
        });
    });
    </script>
</body>
</html>